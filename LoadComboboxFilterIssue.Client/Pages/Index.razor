@page "/"
@using DevExtreme.AspNet.Data
@using DevExtreme.AspNet.Data.ResponseModel
@using System.Collections
@using System.Linq.Expressions
@using System.Diagnostics
@using System.Net.Http.Json
@using LoadComboboxFilterIssue.Client.Components
@using LoadComboboxFilterIssue.Database
@inject HttpClient HttpClient
@inject NavigationManager NavigationManager

@* Debug Metrics *@
<Metrics />

@* Combobox *@
<DxComboBox TData="MyEntity" 
            TValue="MyEntity"
            KeyFieldName="@(nameof(MyEntity.Id))"
            CustomData="CustomDataProvider"
            ListRenderMode="ListRenderMode.Virtual"
            TextFieldName="@(nameof(MyEntity.Name))"
            SearchMode="ListSearchMode.AutoSearch"
            SearchFilterCondition="ListSearchFilterCondition.Contains"
            SearchDelay="500" />

@code {

    async Task<LoadResult> CustomDataProvider(DataSourceLoadOptionsBase options, CancellationToken cancellationToken)
    {
        // Call the controller endpoint
        var url = new Uri(new Uri(NavigationManager.BaseUri), "entities/combobox");
        var result = await HttpClient.PostAsJsonAsync(url, options, cancellationToken);
        result.EnsureSuccessStatusCode();

        // Serialize the response content
        return await result.Content.ReadFromJsonAsync<LoadResult>(cancellationToken) ?? new();
    }
}